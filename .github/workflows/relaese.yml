name: Release

on:
  push:
    tags:
      - "*"

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest
    container: registry.gitlab.com/finestructure/spi-images:android-6.1-latest
    steps:
      - uses: actions/checkout@v4
      - run: swiftc -swift-version 6 -O hello.swift -o hello-android
      - run: gzip hello-android
      - uses: actions/upload-artifact@v4
        with:
          name: hello-android
          path: hello-android.gz

  build-linux:
    runs-on: ubuntu-latest
    container: swift:latest
    steps:
      - uses: actions/checkout@v4
      - run: swiftc -swift-version 6 -O hello.swift -o hello-linux
      - run: gzip hello-linux
      - uses: actions/upload-artifact@v4
        with:
          name: hello-linux
          path: hello-linux.gz

  build-macos:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - run: sudo xcode-select --switch /Applications/Xcode_16.4.app
      - run: swiftc -swift-version 6 -O hello.swift -o hello-macos
      - run: gzip hello-macos
      - uses: actions/upload-artifact@v4
        with:
          name: hello-macos
          path: hello-macos.gz

  release:
    needs: [build-android, build-linux, build-macos]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      - name: Extract all files
        run: |
          cd artifacts
          for file in */*.gz; do
            echo "$file"
            gzip -d "$file"
          done
          cd ../
      - name: Create GitHub Release
        run: gh release create ${{ github.ref_name }} ./artifacts/*/hello-* --generate-notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
